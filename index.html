
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>MoodCard 心情小卡</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #fefefe;
      text-align: center;
      padding: 2em;
    }
    .card {
      margin-top: 1em;
      border: 2px dashed #888;
      padding: 1em;
      width: 300px;
      margin: 1em auto;
      background: #fff4ec;
      border-radius: 10px;
    }
    select, button {
      margin-top: 1em;
      font-size: 1em;
      padding: 0.5em;
    }
    canvas {
      margin-top: 1em;
    }
    .history {
      margin-top: 2em;
    }
  </style>
</head>
<body>
  <h1>MoodCard 心情小卡</h1>

  <!-- Google 登入按鈕 -->
  <div id="g_id_onload"
       data-client_id="320125835242-4ga3v177d0cc5masfq158bi4h6e8k2b0.apps.googleusercontent.com"
       data-callback="onSignIn"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="sign_in_with"
       data-shape="rectangular"
       data-logo_alignment="left">
  </div>

  <p id="userDisplay">👤 尚未登入</p>

  <label>請選擇今天的心情：</label><br/>
  <select id="moodSelect">
    <option value="開心">😊 開心 / Happy</option>
    <option value="焦慮">😰 焦慮 / Anxious</option>
    <option value="疲憊">😩 疲憊 / Tired</option>
    <option value="沮喪">😞 沮喪 / Depressed</option>
  </select><br/>
  <button onclick="generateCard()">產生心情小卡</button>

  <div class="card" id="moodCard" style="display: none;">
    <h2 id="moodText"></h2>
    <p id="moodDesc"></p>
    <button onclick="downloadCard()">下載小卡</button>
  </div>

  <div class="history">
    <h3>過去的心情記錄</h3>
    <ul id="historyList"></ul>
  </div>

  <canvas id="chart" width="400" height="200"></canvas>
  <canvas id="canvas" width="400" height="300" style="display: none;"></canvas>

  <script>
    let currentUser = null;

    const emojis = { "開心": "😊", "焦慮": "😰", "疲憊": "😩", "沮喪": "😞" };

    function generateDescription(mood, userEmail) {
      const base = {
        "開心": "今天的你像小太陽一樣閃耀 ✨ 保持好心情！",
        "焦慮": "事情再多也要記得呼吸，放鬆一下 🙂",
        "疲憊": "今天好像用光了全部的能量？給自己多一點休息 ☕",
        "沮喪": "低潮也沒關係，你真的已經很努力了 ❤️"
      };
      const name = userEmail ? userEmail.split('@')[0] : "你";
      return `${base[mood]}\n💌 ${name}，加油喔！`;
    }

    function generateCard() {
      const mood = document.getElementById('moodSelect').value;
      const date = new Date().toLocaleDateString();
      const emoji = emojis[mood];
      const userText = currentUser ? `👤 使用者：${currentUser}` : '👤 尚未登入';

      document.getElementById('moodText').innerText = `${emoji} 心情：${mood}`;
      document.getElementById('moodDesc').innerText =
        `${generateDescription(mood, currentUser)}\n📅 日期：${date}\n${userText}`;
      document.getElementById('moodCard').style.display = 'block';

      const record = { date: date, mood: mood };
      const history = JSON.parse(localStorage.getItem('moodHistory') || '[]');
      history.push(record);
      localStorage.setItem('moodHistory', JSON.stringify(history));
      updateHistory();
      updateChart();
    }

    function updateHistory() {
      const list = document.getElementById('historyList');
      const history = JSON.parse(localStorage.getItem('moodHistory') || '[]');
      list.innerHTML = '';
      history.slice(-10).reverse().forEach(item => {
        const li = document.createElement('li');
        li.innerText = `${item.date} - ${item.mood}`;
        list.appendChild(li);
      });
    }

    function updateChart() {
      const history = JSON.parse(localStorage.getItem('moodHistory') || '[]');
      const count = { "開心": 0, "焦慮": 0, "疲憊": 0, "沮喪": 0 };
      history.forEach(item => count[item.mood]++);
      chart.data.datasets[0].data = Object.values(count);
      chart.update();
    }

    function downloadCard() {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#fff4ec";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#333";
      ctx.font = "20px sans-serif";
      ctx.fillText(document.getElementById("moodText").innerText, 20, 60);

      ctx.font = "16px sans-serif";
      const lines = document.getElementById("moodDesc").innerText.split("\n");
      lines.forEach((line, index) => {
        ctx.fillText(line, 20, 100 + index * 30);
      });

      const link = document.createElement("a");
      link.download = "moodcard.png";
      link.href = canvas.toDataURL();
      link.click();
    }

    function onSignIn(response) {
      const credential = response.credential;
      const payload = parseJwt(credential);
      currentUser = payload.email;
      document.getElementById('userDisplay').innerText = "👤 使用者：" + currentUser;
      alert("已登入：" + currentUser);
      loadUserData();
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function loadUserData() {
      const data = JSON.parse(localStorage.getItem('user_' + currentUser) || '[]');
      localStorage.setItem('moodHistory', JSON.stringify(data));
      chart.data.datasets[0].data = [0, 0, 0, 0];
      updateHistory();
      updateChart();
    }

    function saveUserData() {
      if (currentUser) {
        const data = JSON.parse(localStorage.getItem('moodHistory') || '[]');
        localStorage.setItem('user_' + currentUser, JSON.stringify(data));
      }
    }

    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function (key, value) {
      originalSetItem.apply(this, arguments);
      if (key === 'moodHistory') {
        saveUserData();
      }
    }

    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['開心', '焦慮', '疲憊', '沮喪'],
        datasets: [{
          label: '心情統計',
          data: [0, 0, 0, 0],
          backgroundColor: ['#fbc02d', '#ef5350', '#90caf9', '#a1887f']
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    updateHistory();
    updateChart();
  </script>
</body>
</html>
