
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>MoodCard å¿ƒæƒ…å°å¡</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #fefefe;
      text-align: center;
      padding: 2em;
    }
    .card {
      margin-top: 1em;
      border: 2px dashed #888;
      padding: 1em;
      width: 300px;
      margin: 1em auto;
      background: #fff4ec;
      border-radius: 10px;
    }
    select, button {
      margin-top: 1em;
      font-size: 1em;
      padding: 0.5em;
    }
    canvas {
      margin-top: 1em;
    }
    .history {
      margin-top: 2em;
    }
  </style>
</head>
<body>
  <h1>MoodCard å¿ƒæƒ…å°å¡</h1>

  <!-- Google ç™»å…¥æŒ‰éˆ• -->
  <div id="g_id_onload"
       data-client_id="320125835242-4ga3v177d0cc5masfq158bi4h6e8k2b0.apps.googleusercontent.com"
       data-callback="onSignIn"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="sign_in_with"
       data-shape="rectangular"
       data-logo_alignment="left">
  </div>

  <p id="userDisplay">ğŸ‘¤ å°šæœªç™»å…¥</p>

  <label>è«‹é¸æ“‡ä»Šå¤©çš„å¿ƒæƒ…ï¼š</label><br/>
  <select id="moodSelect">
    <option value="é–‹å¿ƒ">ğŸ˜Š é–‹å¿ƒ / Happy</option>
    <option value="ç„¦æ…®">ğŸ˜° ç„¦æ…® / Anxious</option>
    <option value="ç–²æ†Š">ğŸ˜© ç–²æ†Š / Tired</option>
    <option value="æ²®å–ª">ğŸ˜ æ²®å–ª / Depressed</option>
  </select><br/>
  <button onclick="generateCard()">ç”¢ç”Ÿå¿ƒæƒ…å°å¡</button>

  <div class="card" id="moodCard" style="display: none;">
    <h2 id="moodText"></h2>
    <p id="moodDesc"></p>
    <button onclick="downloadCard()">ä¸‹è¼‰å°å¡</button>
  </div>

  <div class="history">
    <h3>éå»çš„å¿ƒæƒ…è¨˜éŒ„</h3>
    <ul id="historyList"></ul>
  </div>

  <canvas id="chart" width="400" height="200"></canvas>
  <canvas id="canvas" width="400" height="300" style="display: none;"></canvas>

  <script>
    let currentUser = null;

    const emojis = { "é–‹å¿ƒ": "ğŸ˜Š", "ç„¦æ…®": "ğŸ˜°", "ç–²æ†Š": "ğŸ˜©", "æ²®å–ª": "ğŸ˜" };

    function generateDescription(mood, userEmail) {
      const base = {
        "é–‹å¿ƒ": "ä»Šå¤©çš„ä½ åƒå°å¤ªé™½ä¸€æ¨£é–ƒè€€ âœ¨ ä¿æŒå¥½å¿ƒæƒ…ï¼",
        "ç„¦æ…®": "äº‹æƒ…å†å¤šä¹Ÿè¦è¨˜å¾—å‘¼å¸ï¼Œæ”¾é¬†ä¸€ä¸‹ ğŸ™‚",
        "ç–²æ†Š": "ä»Šå¤©å¥½åƒç”¨å…‰äº†å…¨éƒ¨çš„èƒ½é‡ï¼Ÿçµ¦è‡ªå·±å¤šä¸€é»ä¼‘æ¯ â˜•",
        "æ²®å–ª": "ä½æ½®ä¹Ÿæ²’é—œä¿‚ï¼Œä½ çœŸçš„å·²ç¶“å¾ˆåŠªåŠ›äº† â¤ï¸"
      };
      const name = userEmail ? userEmail.split('@')[0] : "ä½ ";
      return `${base[mood]}\nğŸ’Œ ${name}ï¼ŒåŠ æ²¹å–”ï¼`;
    }

    function generateCard() {
      const mood = document.getElementById('moodSelect').value;
      const date = new Date().toLocaleDateString();
      const emoji = emojis[mood];
      const userText = currentUser ? `ğŸ‘¤ ä½¿ç”¨è€…ï¼š${currentUser}` : 'ğŸ‘¤ å°šæœªç™»å…¥';

      document.getElementById('moodText').innerText = `${emoji} å¿ƒæƒ…ï¼š${mood}`;
      document.getElementById('moodDesc').innerText =
        `${generateDescription(mood, currentUser)}\nğŸ“… æ—¥æœŸï¼š${date}\n${userText}`;
      document.getElementById('moodCard').style.display = 'block';

      const record = { date: date, mood: mood };
      const history = JSON.parse(localStorage.getItem('moodHistory') || '[]');
      history.push(record);
      localStorage.setItem('moodHistory', JSON.stringify(history));
      updateHistory();
      updateChart();
    }

    function updateHistory() {
      const list = document.getElementById('historyList');
      const history = JSON.parse(localStorage.getItem('moodHistory') || '[]');
      list.innerHTML = '';
      history.slice(-10).reverse().forEach(item => {
        const li = document.createElement('li');
        li.innerText = `${item.date} - ${item.mood}`;
        list.appendChild(li);
      });
    }

    function updateChart() {
      const history = JSON.parse(localStorage.getItem('moodHistory') || '[]');
      const count = { "é–‹å¿ƒ": 0, "ç„¦æ…®": 0, "ç–²æ†Š": 0, "æ²®å–ª": 0 };
      history.forEach(item => count[item.mood]++);
      chart.data.datasets[0].data = Object.values(count);
      chart.update();
    }

    function downloadCard() {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#fff4ec";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#333";
      ctx.font = "20px sans-serif";
      ctx.fillText(document.getElementById("moodText").innerText, 20, 60);

      ctx.font = "16px sans-serif";
      const lines = document.getElementById("moodDesc").innerText.split("\n");
      lines.forEach((line, index) => {
        ctx.fillText(line, 20, 100 + index * 30);
      });

      const link = document.createElement("a");
      link.download = "moodcard.png";
      link.href = canvas.toDataURL();
      link.click();
    }

    function onSignIn(response) {
      const credential = response.credential;
      const payload = parseJwt(credential);
      currentUser = payload.email;
      document.getElementById('userDisplay').innerText = "ğŸ‘¤ ä½¿ç”¨è€…ï¼š" + currentUser;
      alert("å·²ç™»å…¥ï¼š" + currentUser);
      loadUserData();
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }

    function loadUserData() {
      const data = JSON.parse(localStorage.getItem('user_' + currentUser) || '[]');
      localStorage.setItem('moodHistory', JSON.stringify(data));
      chart.data.datasets[0].data = [0, 0, 0, 0];
      updateHistory();
      updateChart();
    }

    function saveUserData() {
      if (currentUser) {
        const data = JSON.parse(localStorage.getItem('moodHistory') || '[]');
        localStorage.setItem('user_' + currentUser, JSON.stringify(data));
      }
    }

    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function (key, value) {
      originalSetItem.apply(this, arguments);
      if (key === 'moodHistory') {
        saveUserData();
      }
    }

    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['é–‹å¿ƒ', 'ç„¦æ…®', 'ç–²æ†Š', 'æ²®å–ª'],
        datasets: [{
          label: 'å¿ƒæƒ…çµ±è¨ˆ',
          data: [0, 0, 0, 0],
          backgroundColor: ['#fbc02d', '#ef5350', '#90caf9', '#a1887f']
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    updateHistory();
    updateChart();
  </script>
</body>
</html>
