<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>MoodCard å¿ƒæƒ…å°å¡ âœ¨</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #fffdf7;
      text-align: center;
      padding: 2em;
      color: #333;
    }
    h1 {
      font-size: 2em;
      color: #ff7e67;
    }
    .card {
      margin-top: 1em;
      border: 3px dotted #ffb6b9;
      padding: 1.5em;
      width: 320px;
      margin: 1em auto;
      background: #fff0f5;
      border-radius: 20px;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
    }
    select, button, textarea {
      margin-top: 1em;
      font-size: 1em;
      padding: 0.6em;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    textarea {
      width: 80%;
    }
    canvas {
      margin-top: 2em;
    }
    .history, .chatbox {
      margin-top: 2em;
    }
    .chatbox ul {
      list-style: none;
      padding: 0;
    }
    .chatbox li {
      background: #ffe0e9;
      margin: 5px auto;
      padding: 0.5em 1em;
      border-radius: 10px;
      width: 70%;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>ğŸ§¸ MoodCard å¿ƒæƒ…å°å¡</h1>

  <div id="g_id_onload"
       data-client_id="320125835242-4ga3v177d0cc5masfq158bi4h6e8k2b0.apps.googleusercontent.com"
       data-callback="onSignIn"
       data-auto_prompt="false">
  </div>
  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="sign_in_with"
       data-shape="pill"
       data-logo_alignment="left">
  </div>

  <p id="userDisplay">ğŸ‘¤ å°šæœªç™»å…¥</p>

  <label>ğŸŒˆ è«‹é¸æ“‡ä»Šå¤©çš„å¿ƒæƒ…ï¼š</label><br/>
  <select id="moodSelect">
    <option value="é–‹å¿ƒ">ğŸ˜Š é–‹å¿ƒ</option>
    <option value="ç„¦æ…®">ğŸ˜° ç„¦æ…®</option>
    <option value="ç–²æ†Š">ğŸ˜© ç–²æ†Š</option>
    <option value="æ²®å–ª">ğŸ˜ æ²®å–ª</option>
  </select><br/>
  <button onclick="generateCard()">ğŸ´ ç”¢ç”Ÿå¿ƒæƒ…å°å¡</button>

  <div class="card" id="moodCard" style="display: none;">
    <h2 id="moodText"></h2>
    <p id="moodDesc"></p>
    <p id="moodAdvice" style="font-style: italic; color:#aa4488;"></p>
    <button onclick="downloadCard()">â¬‡ï¸ ä¸‹è¼‰å°å¡</button>
  </div>

  <div class="history">
    <h3>ğŸ“… éå»çš„å¿ƒæƒ…è¨˜éŒ„</h3>
    <ul id="historyList"></ul>
  </div>

  <div class="chatbox">
    <h3>ğŸ—¨ï¸ å¿ƒæƒ…äº¤æµç‰†ï¼ˆåŒ¿åï¼‰</h3>
    <textarea id="chatInput" placeholder="ç•™è¨€ä¸€äº›æƒ³èªªçš„è©±..."></textarea><br/>
    <button onclick="submitChat()">é€å‡ºç•™è¨€</button>
    <ul id="chatList"></ul>
  </div>

  <canvas id="chart" width="400" height="200"></canvas>
  <canvas id="canvas" width="400" height="300" style="display: none;"></canvas>

  <script>
    const moodMessages = {
      "é–‹å¿ƒ": ["ä»Šå¤©çš„ä½ å……æ»¿é™½å…‰èˆ‡æ­£èƒ½é‡ï¼", "ä½ çš„ç¬‘å®¹æ˜¯ä¸–ç•Œæœ€æº«æš–çš„å…‰ã€‚", "åˆ¥å¿˜äº†æŠŠå¿«æ¨‚åˆ†äº«å‡ºå»ï¼"],
      "ç„¦æ…®": ["å…ˆæ·±å‘¼å¸ï¼Œæ…¢æ…¢ä¾†ï¼Œä¸€æ­¥æ­¥å°±å¥½ã€‚", "ä½ æ­£åœ¨åŠªåŠ›ä¸­ï¼Œé€™å¾ˆæ£’ã€‚", "ç…§é¡§è‡ªå·±ï¼Œæ˜¯æœ€é‡è¦çš„äº‹ã€‚"],
      "ç–²æ†Š": ["ä»Šå¤©è¾›è‹¦äº†ï¼Œåˆ¥å¿˜è¨˜æ”¾é¬†ä¸€ä¸‹ã€‚", "å¥½å¥½ä¼‘æ¯ï¼Œæ˜¯å°è‡ªå·±æœ€å¥½çš„çå‹µã€‚", "æ™šé»ä¾†æ¯ç†±å¯å¯å§ â˜•"],
      "æ²®å–ª": ["ä½ å·²ç¶“å¾ˆæ£’äº†ï¼Œåˆ¥å¤ªè‹›è²¬è‡ªå·±ã€‚", "é¡˜ä½ æ˜å¤©æ¯”ä»Šå¤©æ›´å¹³éœã€‚", "ä½ çš„åŠªåŠ›ä¸æœƒè¢«ç™½è²»ã€‚"]
    };

    let currentUser = null;

    function onSignIn(response) {
      const credential = response.credential;
      const payload = parseJwt(credential);
      currentUser = payload.email;
      document.getElementById('userDisplay').innerText = "ğŸ‘¤ ä½¿ç”¨è€…ï¼š" + currentUser;
      loadUserData();
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
      ).join(''));
      return JSON.parse(jsonPayload);
    }

    function generateCard() {
      const mood = document.getElementById('moodSelect').value;
      const emoji = { "é–‹å¿ƒ": "ğŸ˜Š", "ç„¦æ…®": "ğŸ˜°", "ç–²æ†Š": "ğŸ˜©", "æ²®å–ª": "ğŸ˜" }[mood];
      const date = new Date().toLocaleDateString();
      const userText = currentUser ? `ğŸ‘¤ ä½¿ç”¨è€…ï¼š${currentUser}` : 'ğŸ‘¤ åŒ¿åä½¿ç”¨è€…';
      const randomAdvice = moodMessages[mood][Math.floor(Math.random() * moodMessages[mood].length)];
      document.getElementById('moodText').innerText = `${emoji} å¿ƒæƒ…ï¼š${mood}`;
      document.getElementById('moodDesc').innerText = `${userText} - ${date}`;
      document.getElementById('moodAdvice').innerText = randomAdvice;
      document.getElementById('moodCard').style.display = 'block';

      const record = { date: date, mood: mood };
      const history = JSON.parse(localStorage.getItem('moodHistory') || '[]');
      history.push(record);
      localStorage.setItem('moodHistory', JSON.stringify(history));
      updateHistory();
      updateChart();
    }

    function updateHistory() {
      const list = document.getElementById('historyList');
      const history = JSON.parse(localStorage.getItem('moodHistory') || '[]');
      list.innerHTML = '';
      history.slice(-10).reverse().forEach(item => {
        const li = document.createElement('li');
        li.innerText = `${item.date} - ${item.mood}`;
        list.appendChild(li);
      });
    }

    function updateChart() {
      const history = JSON.parse(localStorage.getItem('moodHistory') || '[]');
      const count = { "é–‹å¿ƒ": 0, "ç„¦æ…®": 0, "ç–²æ†Š": 0, "æ²®å–ª": 0 };
      history.forEach(item => count[item.mood]++);
      chart.data.datasets[0].data = Object.values(count);
      chart.update();
    }

    function submitChat() {
      const input = document.getElementById('chatInput').value.trim();
      if (input) {
        const chats = JSON.parse(localStorage.getItem('chatBoard') || '[]');
        chats.push(input);
        localStorage.setItem('chatBoard', JSON.stringify(chats));
        document.getElementById('chatInput').value = '';
        loadChats();
      }
    }

    function loadChats() {
      const list = document.getElementById('chatList');
      const chats = JSON.parse(localStorage.getItem('chatBoard') || '[]');
      list.innerHTML = '';
      chats.slice(-10).reverse().forEach(msg => {
        const li = document.createElement('li');
        li.innerText = msg;
        list.appendChild(li);
      });
    }

    function downloadCard() {
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#fff0f5";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#333";
      ctx.font = "20px sans-serif";
      ctx.fillText(document.getElementById("moodText").innerText, 20, 60);
      ctx.font = "16px sans-serif";
      ctx.fillText(document.getElementById("moodDesc").innerText, 20, 100);
      ctx.fillText(document.getElementById("moodAdvice").innerText, 20, 140);
      const link = document.createElement("a");
      link.download = "moodcard.png";
      link.href = canvas.toDataURL();
      link.click();
    }

    function loadUserData() {
      const data = JSON.parse(localStorage.getItem('user_' + currentUser) || '[]');
      localStorage.setItem('moodHistory', JSON.stringify(data));
      updateHistory();
      updateChart();
    }

    function saveUserData() {
      if (currentUser) {
        const data = JSON.parse(localStorage.getItem('moodHistory') || '[]');
        localStorage.setItem('user_' + currentUser, JSON.stringify(data));
      }
    }

    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function (key, value) {
      originalSetItem.apply(this, arguments);
      if (key === 'moodHistory') {
        saveUserData();
      }
    }

    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['é–‹å¿ƒ', 'ç„¦æ…®', 'ç–²æ†Š', 'æ²®å–ª'],
        datasets: [{
          label: 'å¿ƒæƒ…çµ±è¨ˆ',
          data: [0, 0, 0, 0],
          backgroundColor: ['#ffd54f', '#ef5350', '#90caf9', '#a1887f']
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    updateHistory();
    updateChart();
    loadChats();
  </script>
</body>
</html>
